<!DOCTYPE html>
<!--
COPYRIGHT AND LICENSE

Copyright 2014 The Regents of the University of California All Rights Reserved

Permission to copy, modify and distribute any part of this realtime-segmentation for 
educational, research and non-profit purposes, without fee, and without a 
written agreement is hereby granted, provided that the above copyright notice, 
this paragraph and the following three paragraphs appear in all copies.

Those desiring to incorporate this realtime-segmentation into commercial products
or use for commercial purposes should contact the Technology Transfer Office, 
University of California, San Diego, 9500 Gilman Drive, Mail Code 0910, 
La Jolla, CA 92093-0910, Ph: (858) 534-5815, FAX: (858) 534-7345, 
E-MAIL:invent@ucsd.edu.

IN NO EVENT SHALL THE UNIVERSITY OF CALIFORNIA BE LIABLE TO ANY PARTY FOR 
DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES, INCLUDING 
LOST PROFITS, ARISING OUT OF THE USE OF THIS realtime-segmentation, EVEN IF THE UNIVERSITY 
OF CALIFORNIA HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

THE realtime-segmentation PROVIDED HEREIN IS ON AN "AS IS" BASIS, AND THE UNIVERSITY 
OF CALIFORNIA HAS NO OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT, UPDATES, 
ENHANCEMENTS, OR MODIFICATIONS. THE UNIVERSITY OF CALIFORNIA MAKES NO 
REPRESENTATIONS AND EXTENDS NO WARRANTIES OF ANY KIND, EITHER IMPLIED OR 
EXPRESS, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF 
MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, OR THAT THE USE OF 
THE realtime-segmentation WILL NOT INFRINGE ANY PATENT, TRADEMARK OR OTHER RIGHTS. 
-->


<!DOCTYPE html>

<html>

    <head>

        <title>Real time Segmentation via CHM</title>

        <meta charset="utf-8" />

        <meta http-equiv="cache-control" content="no-cache" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0">


        <link rel="stylesheet" href="leaflet-0.7.3/leaflet.css" />

        <style>
           html,body {
             height: 99%;
             width: 99%;
             position: relative;
           }
           #status {
             background-color:#8F8F8F;
             width:200px;
             height: 100%;
             padding:10px;
             position: fixed;
             top: 0px;
             left: 0px;
             border: 1px solid #8F8F8F;
           }
           #map {
             border: 1px solid black;
             width:99%;
             height: 99%;
             padding:10px;
             position: fixed;
             top: 0px;
             left: 220px;
           }
        </style>
        
    </head>

    <body>
        
                
        <div id="status">
           Realtime Segmentation<p/>
           <div style="display: inline-block">&nbsp;</div><br/>
           # Tiles to Process: <div id="tilestoprocess" style="display: inline-block;">?</div></br>
           Est. Time (minutes): <div id="esttimehours" style="display: inline-block;">?</div><br/>
           Est. CPU (hours): <div id="estcpuhours" style="display: inline-block;">?</div><br/>
           <br/>
           # Tiles Processed: <div id="tilesprocessed" style="display: inline-block;">?</div><br/>
           # Cores in Use:  <div id="numcoresinuse" style="display: inline-block;">?</div><br/>
           CPU Consumed (hours): <div id="cpuconsumedhours" style="display: inline-block;">?</div><br/>
           Avg. Time per tile (secs): <div id="avgtimepertile" style="display: inline-block;">?</div><br/>
           <br/>
           <button type="button" onclick="refreshOverlays()">Refresh Map</button>
        </div>
        
        <div id="map"></div>

        
        <script src="leaflet-0.7.3/leaflet.js"></script>
        <script>

        //need to subtract from all bounds otherwise the tiles in r-1 and c-1
        //are requested
        var southWest = L.latLng(@@IMAGE_HEIGHT_NEGATIVE@@, 1);
        var northEast = L.latLng(-1, @@IMAGE_WIDTH@@);
      
        var tileBounds = L.latLngBounds(southWest, northEast);

        var paddedTileBounds = tileBounds.pad(0.05);
       
        @@BASE_IMAGE_LAYER_DEC@@
        
        @@CUSTOM_LAYERS_DECS@@
       
            var baseMaps = {
                "@@BASE_MAP_NAME@@": @@BASE_LAYER_VAR_NAME@@,
            };

            var overlayMaps = {
                @@CUSTOM_LAYERS_OVERLAYS@@
            };


            var map = L.map('map', {
                crs: L.CRS.Simple,
                maxBounds: paddedTileBounds,
                zoomControl: false,
                attributionControl: false
                
            });
            var attribution = L.control.attribution({
                position: 'topleft',
                prefix: 'Display powered by <a href="http://leafletjs.com">Leaflet</a>'
            });
            
            map.addControl(attribution);
            
            L.control.layers(baseMaps, overlayMaps,
            { position: 'topleft'}).addTo(map);

            map.setView([-500, 740], 0);

            var popup = L.popup();

            function onMapClick(e) {
                popup
                        .setLatLng(e.latlng)
                        .setContent("Container location: ("
                                + e.containerPoint.toString() + ") Map Location: ("
                                + e.layerPoint.toString() + ") LatLong: (" + e.latlng.toString() + ")")
                        .openOn(map);

            }

            map.on('click', onMapClick);
            
            var xmlhttp = new XMLHttpRequest();
            
            var tilesToProcessElement = document.getElementById("tilestoprocess");
            var estTimeHoursElement = document.getElementById("esttimehours");
            var estCpuHoursElement = document.getElementById("estcpuhours");
            var tilesProcessedElement = document.getElementById("tilesprocessed");
            var cpuConsumedHoursElement = document.getElementById("cpuconsumedhours");
            var avgTimePerTileElement = document.getElementById("avgtimepertile");
            var numCoresInUseElement = document.getElementById("numcoresinuse");
            
            function refreshOverlays() {
                 @@CUSTOM_LAYERS_REDRAWS@@
            }
            
            // the interval function should ask the server if any new tiles have
            // appeared since last call and to update the layer if so otherwise
            // not to do anything
            setInterval(function() {
                xmlhttp.open("GET","/status",false);
                xmlhttp.send();
                var myres = JSON.parse(xmlhttp.responseText);
                tilesToProcessElement.innerHTML = myres.tilestoprocess;
                estTimeHoursElement.innerHTML = myres.esttimehours;
                tilesProcessedElement.innerHTML = myres.tilesprocessed;
                cpuConsumedHoursElement.innerHTML = myres.cpuconsumedhours;
                avgTimePerTileElement.innerHTML = myres.avgtimepertile;
                estCpuHoursElement.innerHTML = myres.estcpuhours;
                numCoresInUseElement.innerHTML = myres.numcoresinuse;
                if (myres.tilestoprocess > 0 || myres.futuretasklistsize > 0){
                   refreshOverlays();
                }
            }, 10000);

        </script>
    </body>
</html>
